# 资源共享协议设计案（已实装）

资源共享协议用于在多房间之间共享彼此的资源。

# 设计思路

**来源表**

在全局维护一个资源来源表，标注了可以被共享的资源名称以及能提供该资源的房间。该表是惰性的，注册之后并不会被主动维护。

**控制器**

控制器是开放在 `Room` 上的一组 api，是资源来源表的操作封装。控制器可以响应资源共享请求以及添加、移除资源来源房间。在收到资源共享请求时，控制器会检查来源表中的对应资源的提供房间并向可以提供资源的房间派发共享任务，在此期间会检查并移除无法继续提供资源的房间。

**执行器**

terminal 会根据自己的规则对资源进行监听，如果不足的话会将自己的需求委托给资源共享控制器。控制器会尝试向能提供资源的房间派发共享任务，并返回是否有房间响应了共享请求。terminal 则会根据返回值决定下一步操作。

# 资源来源表

```js
{
    // 其键代表资源类型，值为数组，包含了可以提供该资源的房间名
    [RESOURCE_HYDROGEN]: [ 'W1N2', 'W3N4' ],
    [RESOURCE_KEANIUM]: [ 'W5N6', 'W2N6' ],
    // ...
}
```

# 资源共享控制器 API

控制器的主要作用是提供一套 API 来方便 terminal 、资源来源表、来源房间之间的沟通，不会主动运行，仅被动响应委托者的请求。拓展在 `Room` 原型内，具体设计如下：

向控制器请求资源，接受资源类型和数量，返回有没有安排上

```ts
shareRequest(resourceType, amount): boolean
```

在资源来源表中添加自己, 返回是否添加成功（添加失败的主要原因是已经添加过了）

```ts
shareAddSource(resourceType): boolean
```

在资源来源表中移除自己

```ts
shareRemoveSource(resourceType): void
```

私有方法，给本房间发添加资源共享任务，接受目标房间名、资源类型和数量，返回是否添加成功

```ts
shareAdd(targetRoom, resourceType, amount): boolean
```

# 关于能量共享

拓展 storage 原型，每 10000 tick 会检查一下自己的能量，如果大于指定上限（`setting.ts` > `ENERGY_SHARE_LIMIT`）就将自己加入到资源来源表里。

控制器在收到能量共享请求时，会依次检查能量来源房间的 storage，如果能量还是大于指定上限则分配任务，否则直接移除该房间